{% extends 'company/company-template.html.twig' %}

{% form_theme form _self %} {# Dans ce fichier, pour la variable form on utilise le theme personnalisé plus bas #}

{% block company_body %}
    {{ form_start(form) }}
    <input type="hidden" value="{{ company.companyCategory.id }}" id="companyCategoryToCheck">
    <div class="row">
        <div class="col-6">{{ form_row(form.name) }}</div>
        <div class="col-3">{{ form_row(form.country) }}</div>
        <div class="col-3">
            <label for="companyCategory">Type de société</label>
            <select id="companyCategory" class="form-control" name="company[companyCategory]">
                <option selected disabled>Choisissez un type de société...</option>
            </select>
        </div>
    </div>
    {{ form_end(form) }}
{% endblock %}

{% block _company_shareholders_widget %} {# Theme personnalisé pour la balise avec l'id company_shareholders #}
    {{ form_widget(form) }}
    <div class="form-group">
        <button type="button" id="add-shareholder" class="btn btn-success">Ajouter un actionnaire</button>
    </div>
{% endblock %}

{% block _company_shareholders_entry_row %}
    {{ form_widget(form) }}
{% endblock %}

{% block _company_shareholders_entry_widget %}
    <div class="form-group" id="block_{{ id }}">
        <div class="row">
            <div class="col-10">
                <div class="row">
                    <div class="col">{{ form_widget(form.shareholder) }}</div>
                    <div class="col">{{ form_widget(form.part) }}</div>
                </div>
            </div>
            <div class="col-2">
                <button type="button" data-action="delete" data-target="#block_{{ id }}" class="btn btn-danger">X</button>
            </div>
        </div>
    </div>
{% endblock %}




{% block js %}
    <script>

        $(function() {
            // Ajout des actionnaires
            $('#add-shareholder').on('click', function() {
                const index = $('#company_shareholders div.form-group').length;
                const template = $('#company_shareholders').data('prototype').replace(/__name__/g, index);
                $('#company_shareholders').append(template);
                handleDeleteButtons();
            });

            function handleDeleteButtons(){
                $('button[data-action="delete"]').on('click', function () {
                    const target = this.dataset.target;
                    $(target).remove();
                });
            }
            handleDeleteButtons();

            // Ajax pour remplir le type de société par rapport au pays
            $('#company_country').on('change', function () {
                const url = 'http://127.0.0.1:8000/admin/company/category/ajax/';
                const countryId = $('#company_country').val();
                $.ajax({
                    url: url + countryId,
                    type: 'get',
                })
                    .done(function (datas) {
                        for(const option of $('#companyCategory option')){
                            if (option.value.length < 8){
                                option.remove();
                            }
                        }
                        for(const data of datas){
                            $('#companyCategory').append(`<option value="${data.abbreviation}">${data.abbreviation} - ${data.name}</option>`);
                        }
                    })
            });

            // Event au chargement de la page pour sélectionner la bonne catégorie de société
            const url = 'http://127.0.0.1:8000/admin/company/category/ajax/';
            const countryId = $('#company_country').val();
            $.ajax({
                url: url + countryId,
                type: 'get',
            })
                .done(function (datas) {
                    for(const option of $('#companyCategory option')){
                        if (option.value.length < 8){
                            option.remove();
                        }
                    }
                    for(const data of datas){
                        if(data.id == $('#companyCategoryToCheck').val()){
                            // Sélection du champs présent en db
                            $('#companyCategory').append(`<option selected value="${data.abbreviation}">${data.abbreviation} - ${data.name}</option>`)
                        } else {
                            $('#companyCategory').append(`<option value="${data.abbreviation}">${data.abbreviation} - ${data.name}</option>`);
                        }
                    }
                })
        })


    </script>
{% endblock %}